<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini hra – Klikni na cieľ</title>
  <style>
    body {
      margin: 0;
      background-color: #222;
      color: white;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: .5rem;
    }
    #game {
      position: relative;
      width: 400px;
      height: 400px;
      background: #333;
      overflow: hidden;
      border: 2px solid #555;
    }
    .target {
      position: absolute;
      width: 50px;
      height: 50px;
      background: red;
      border-radius: 50%;
      cursor: pointer;
      user-select: none;
    }
    #endOverlay {
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.6);
      text-align: center;
      padding: 1rem;
    }
    button {
      background: #0ea5e9;
      border: none;
      color: #fff;
      padding: .6rem 1rem;
      border-radius: .5rem;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { filter: brightness(1.1); }
    .row { display:flex; gap:1rem; flex-wrap: wrap; justify-content:center; }
    .notice { opacity: .8; font-size: .9rem; }
    a { color: #9ae6ff; }
  </style>
</head>
<body>
  <h1>Klikni na cieľ!</h1>
  <div class="notice">Odkaz musí pochádzať z príkazu <code>/play</code> v Discorde. Token vyprší za ~15 minút.</div>

  <div class="row">
    <p>Skóre: <span id="score">0</span> / <span id="max">50</span></p>
    <p>Reakčný čas: <span id="reaction">0</span> ms</p>
    <p>Najlepší: <span id="best">-</span> ms</p>
    <p>Priemer: <span id="average">-</span> ms</p>
  </div>

  <div id="game">
    <div id="endOverlay">
      <div>
        <h2>Hotovo!</h2>
        <p>Skóre: <span id="finalScore">0</span>/<span id="finalMax">50</span></p>
        <p>Najlepší čas: <strong id="finalBest">-</strong> ms</p>
        <p>Priemerný čas: <strong id="finalAvg">-</strong> ms</p>
        <p id="submitState">Odosielam výsledok do Discordu…</p>
        <button id="restartBtn">Reštartovať</button>
      </div>
    </div>
  </div>

  <script>
    const MAX_CLICKS = 50;

    const params = new URLSearchParams(location.search);
    const token = params.get('t');

    const game = document.getElementById('game');
    const scoreDisplay = document.getElementById('score');
    const maxDisplay = document.getElementById('max');
    const reactionDisplay = document.getElementById('reaction');
    const bestDisplay = document.getElementById('best');
    const averageDisplay = document.getElementById('average');

    const endOverlay = document.getElementById('endOverlay');
    const restartBtn = document.getElementById('restartBtn');
    const finalScore = document.getElementById('finalScore');
    const finalMax = document.getElementById('finalMax');
    const finalBest = document.getElementById('finalBest');
    const finalAvg = document.getElementById('finalAvg');
    const submitState = document.getElementById('submitState');

    maxDisplay.textContent = MAX_CLICKS;
    finalMax.textContent = MAX_CLICKS;

    let score, spawnTime, bestTime, totalTime, gameOver;

    function resetState() {
      score = 0;
      spawnTime = 0;
      bestTime = null;
      totalTime = 0;
      gameOver = false;

      scoreDisplay.textContent = '0';
      reactionDisplay.textContent = '0';
      bestDisplay.textContent = '-';
      averageDisplay.textContent = '-';
      submitState.textContent = 'Odosielam výsledok do Discordu…';

      // vyčisti plochu
      game.querySelectorAll('.target').forEach(t => t.remove());
      endOverlay.style.display = 'none';
    }

    function spawnTarget() {
      if (gameOver) return;

      const target = document.createElement('div');
      target.classList.add('target');
      target.style.left = Math.random() * (game.clientWidth - 50) + 'px';
      target.style.top  = Math.random() * (game.clientHeight - 50) + 'px';

      spawnTime = performance.now();

      target.addEventListener('click', () => {
        const reaction = Math.round(performance.now() - spawnTime);
        reactionDisplay.textContent = reaction;

        score++;
        scoreDisplay.textContent = score;

        if (bestTime === null || reaction < bestTime) {
          bestTime = reaction;
          bestDisplay.textContent = bestTime;
        }

        totalTime += reaction;
        averageDisplay.textContent = Math.round(totalTime / score);

        target.remove();

        if (score >= MAX_CLICKS) {
          endGame();
        } else {
          spawnTarget();
        }
      });

      game.appendChild(target);
    }

    async function endGame() {
      gameOver = true;
      game.querySelectorAll('.target').forEach(t => t.remove());

      finalScore.textContent = score;
      finalBest.textContent = bestTime ?? '-';
      finalAvg.textContent = score > 0 ? Math.round(totalTime / score) : '-';

      endOverlay.style.display = 'flex';

      // Submit score to server if we have token
      if (!token) {
        submitState.textContent = 'Chýba token z Discordu – výsledok sa nezapíše do tabuľky.';
        return;
      }
      try {
        const res = await fetch('/score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token,
            score,
            average: Math.round(totalTime / score),
            best: bestTime ?? 0
          })
        });
        const data = await res.json();
        if (data.ok) {
          submitState.textContent = 'Výsledok úspešne zapísaný. Pozri tabuľku v kanáli.';
        } else {
          submitState.textContent = 'Nepodarilo sa zapísať výsledok: ' + (data.error || 'neznáma chyba');
        }
      } catch (e) {
        submitState.textContent = 'Chyba siete pri odosielaní výsledku.';
      }
    }

    restartBtn.addEventListener('click', () => {
      resetState();
      spawnTarget();
    });

    resetState();
    spawnTarget();
  </script>
</body>
</html>
